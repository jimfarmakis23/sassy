<script>
  function extractVideoId(url) {
    try {
      url = url.trim();
      const patterns = [
        // YouTube patterns
        /(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([^&\n?#]+)/,
        /youtube\.com\/watch\?.+&v=([^&\n?#]+)/,
        // Invidious patterns (Î³Î¹Î± ÎºÎ¬Î¸Îµ Ï€ÎµÏÎ¯Ï€Ï„Ï‰ÏƒÎ·)
        /(?:invidious|yewtu\.be|inv\.)[^\/]+\/watch\?v=([^&\n?#]+)/,
        /(?:invidious|yewtu\.be|inv\.)[^\/]+\/embed\/([^&\n?#]+)/
      ];
      for (let pattern of patterns) {
        const match = url.match(pattern);
        if (match) return match[1];
      }
      const urlObj = new URL(url);
      return urlObj.searchParams.get('v');
    } catch (e) {
      console.error('Error parsing URL:', url, e);
      return null;
    }
  }

  // ğŸ¯ ÎœÎŸÎÎŸ Ï„Î¿ yewtu.be - ÏƒÏ„Î±Î¸ÎµÏÏŒ ÎºÎ±Î¹ Î´Î¿ÎºÎ¹Î¼Î±ÏƒÎ¼Î­Î½Î¿
  const EMBED_BASE = "https://yewtu.be/embed/";

  function buildEmbedSrc(videoId) {
    return `${EMBED_BASE}${videoId}`;
  }

  const titleCache = new Map();
  async function fetchTitle(videoId) {
    if (titleCache.has(videoId)) return titleCache.get(videoId);

    const oembedUrl =
      `https://www.youtube.com/oembed?url=${encodeURIComponent("https://www.youtube.com/watch?v=" + videoId)}&format=json`;

    try {
      const res = await fetch(oembedUrl);
      if (!res.ok) throw new Error("oEmbed failed");
      const data = await res.json();
      const title = (data && data.title) ? data.title : "YouTube Video";
      titleCache.set(videoId, title);
      return title;
    } catch (e) {
      console.warn("Title fetch failed for", videoId, e);
      const fallback = "YouTube Video";
      titleCache.set(videoId, fallback);
      return fallback;
    }
  }

  fetch('./data/links.txt')
    .then(response => {
      if (!response.ok) {
        throw new Error(`Î¤Î¿ Î±ÏÏ‡ÎµÎ¯Î¿ data/links.txt Î´ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ (Status: ${response.status})`);
      }
      return response.text();
    })
    .then(text => {
      const container = document.getElementById('video-container');
      container.innerHTML = '';

      const links = text.split('\n')
        .map(line => line.trim())
        .filter(line => line && !line.startsWith('#'));

      if (links.length === 0) {
        container.innerHTML = '<div class="error-message">Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎ±Î½ links ÏƒÏ„Î¿ Î±ÏÏ‡ÎµÎ¯Î¿</div>';
        return;
      }

      const iframes = [];

      links.forEach((link, idx) => {
        const videoId = extractVideoId(link);
        if (!videoId || videoId.length !== 11) return;

        const card = document.createElement('div');
        card.className = 'video-card';

        const media = document.createElement('div');
        media.className = 'video-media';

        const iframe = document.createElement('iframe');
        // ğŸ¯ Î•Î”Î©: ÎŸÎ›Î‘ Ï„Î± links Î³Î¯Î½Î¿Î½Ï„Î±Î¹ embed Î±Ï€ÏŒ yewtu.be
        iframe.src = buildEmbedSrc(videoId);
        iframe.allow = "accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture";
        iframe.allowFullscreen = true;

        iframe.loading = "lazy";
        iframe.referrerPolicy = "strict-origin-when-cross-origin";
        iframe.title = "YouTube video player";

        media.appendChild(iframe);

        const title = document.createElement('div');
        title.className = 'video-title';
        title.id = `title-${idx}`;
        title.textContent = '...';

        card.appendChild(media);
        card.appendChild(title);
        container.appendChild(card);

        iframes.push({ iframe, videoId, titleEl: title });
      });

      for (let i = 0; i < Math.min(3, iframes.length); i++) {
        iframes[i].iframe.loading = "eager";
      }

      let titleIdx = 0;
      function pumpTitles() {
        const batch = 6;
        const end = Math.min(titleIdx + batch, iframes.length);
        for (; titleIdx < end; titleIdx++) {
          const item = iframes[titleIdx];
          fetchTitle(item.videoId).then(t => item.titleEl.textContent = t);
        }
        if (titleIdx < iframes.length) setTimeout(pumpTitles, 250);
      }
      pumpTitles();
    })
    .catch(error => {
      console.error(error);
      document.getElementById('video-container').innerHTML =
        `<div class="error-message">
            âŒ Î£Ï†Î¬Î»Î¼Î±: ${error.message}<br><br>
            Î’ÎµÎ²Î±Î¹ÏÏƒÎ¿Ï… ÏŒÏ„Î¹:<br>
            1. Î¤Î¿ Î±ÏÏ‡ÎµÎ¯Î¿ <b>data/links.txt</b> Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ ÏƒÏ„Î¿ repository<br>
            2. Î¤Î¿ <b>index.html</b> ÎµÎ¯Î½Î±Î¹ ÏƒÏ„Î¿ root (Î® ÏƒÏ„Î¿ Pages root)<br>
            3. Î¤Î± links ÎµÎ¯Î½Î±Î¹ ÏƒÏ‰ÏƒÏ„Î¬ (Î­Î½Î± ÏƒÎµ ÎºÎ¬Î¸Îµ Î³ÏÎ±Î¼Î¼Î®)<br><br>
            Tip: Î¬Î½Î¿Î¹Î¾Îµ DevTools â†’ Console Î³Î¹Î± Î½Î± Î´ÎµÎ¹Ï‚ Ï„Î¿ Î±ÎºÏÎ¹Î²Î­Ï‚ error.
         </div>`;
    });
</script>
